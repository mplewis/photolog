---
import type { Photo } from "../types";
import type { MetadataReport } from "../common/types";
import MainLayout from "../layouts/MainLayout.astro";
import App from "../components/App.tsx";
import { describeMetadata } from "../logic/desc";
import { readFile } from "fs/promises";

const metadataPath = "../../tmp/metadata.json";
const imageRoot = "/photos";
const thumbnailMaxWidthPx = 800; // anything wider than this is a "full" image

const raw = (await readFile(metadataPath)).toString();
const metadata = JSON.parse(raw) as MetadataReport;

const photos: Photo[] = [];
for (const meta of Object.values(metadata.photos)) {
  const { sizes } = meta;

  const { title, description } = describeMetadata(meta);
  const { date, albums } = meta;
  const urls = sizes.map(({ width, height, path }) => ({
    width,
    height,
    url: `${imageRoot}/${path}`,
    thumbnail: width <= thumbnailMaxWidthPx,
  }));

  photos.push({
    title: title ?? null,
    description,
    date,
    albums,
    assets: urls,
  });
}

photos.sort((a, b) => b.date.getTime() - a.date.getTime());
---

<MainLayout>
  <App client:only albums={metadata.albums} photos={photos} />
</MainLayout>
